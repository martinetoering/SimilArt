<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="author" content="">
    <title>{% block title %}{% endblock %}</title>

    <!-- Bootstrap core CSS -->
    <link href="https://getbootstrap.com/docs/4.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- D3 package -->
    <script src="https://d3js.org/d3.v4.min.js"></script>

    <!-- buttons menu bar -->
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>

    <!-- drop down menu bar -->
    <!--    <meta name="viewport" content="width=device-width, initial-scale=1">-->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

    <!-- Layout stylesheet -->
    <link rel="stylesheet" type="text/css" href="../static/css/test.css">

    <link rel="stylesheet" type="text/css" href="../static/css/collapsed_sidebar.css">
    <script src="../static/js/collapsed_sidebar.js"></script>
</head>


<body>
    <!-- <div id="dissimilar_label" class="label">Dissimilar images</div> -->
    <!-- <div id="similar_label" class="label">Similar images</div> -->
    <div id="myModal" class="modal">
        <!-- Modal content -->
        <div class="modal-content">
            <span class="close">&times;</span>
            <div id="center_image">
                <center><img src="https://uploads8.wikiart.org/images/vajda-lajos/table-still-life-with-armchair-1934.jpg", id="img01" /></center>
            </div>
            <div id="popup_information">
                Artwork name.<br /><br />Artist name (year).
            </div>
        </div>
    </div>

    <div  id="myheader" class="header" style='opacity: 0;'>
        <h6 style="background-color:#d88562; text-align: center; width: 100%; top:0;left: 0; z-index: 0;color: white;font:arial;font-weight: bold;font-; margin-bottom: 0;">
            OmniArt Exploration Area
        </h6>


        <div id="mySidebar" class="sidebar">
            <a href="javascript:void(0)" class="btn closebtn" onclick="closeNav()">Ã—</a>
            <a href="javascript:void(0)" class="btn" onclick="open_search_nav()">Search</a>
            <a href="javascript:void(0)" class="btn" onclick="open_filter_nav()">Filter</a>
        </div>

        <div id="search_mySidebar" class="sidebar" style="margin-left: 250px;">
            <label for="search_cat" class="select_btn_label" style="margin-left: 30px;margin-top: 7px;" >Based on:</label>
            <br>
            <select id="search_cat" class="btn" name="search_cat" style="margin-left: 30px; background-color: white;">
                <option>Art name</option>
                <option>Artist full name</option>
            </select>
            <br>
            <label for="search_key" class="search_key_label">Search Key:</label>
            <input type="text" id="search_key" class="search_key" name="search_key">
            <br><br>
            <a href="javascript:void(0)" class="btn" onclick="my_set_center()">Update</a>
        </div>

        <div id="filter_mySidebar" class="sidebar" style="margin-left: 250px;">
            <!-- start year: <input id="year" type="text" class="span2" value="" data-slider-min="-5000" data-slider-max="2030" data-slider-step="10" data-slider-value="[-5000,2030]"/> -->
            <label for="start_year" class="start_year_label" id="start_year_label">Start year:</label>
            <input type="text" class="start_year" id="start_year" name="start_year" placeholder="-2500 to 2017 (e.g. -5)">
            <br><br>
            <label for="end_year" class="end_year_label" id="end_year_label">End year:</label>
            <input type="text" class="end_year" id="end_year" name="end_year" placeholder="-2500 to 2017 (e.g. 100)">

            <br><br>
            <a href="javascript:void(0)" class="btn" onclick="filter_dissimilar()">Update</a>
        </div>

    </div>
    <div id="container"></div>
</body>

<script type="text/javascript">
    var height_navbar = 19;
    var svgwidth = document.body.clientWidth;
    var svgheight = document.body.clientHeight - height_navbar;
    var center_image_size = 200;
    var similar_image_size = 70;
    var dissimilar_image_size = 40;
    var timer_tooltip;
    var time_till_tooltip_appearance = 500;
</script>

<!-- Import dragable images code -->
<script src="../static/js/drag_imgs.js"></script>
<!-- Import set_center image function -->
<script src="../static/js/center_image.js"></script>
<!-- Import non dragable images code-->
<script src="../static/js/append_imgs.js"></script>
<!-- Import similarity placement code -->
<script src="../static/js/similar_generation.js"></script>
<!-- Imports for the backend connection + nearest neighbor querying -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/1.7.3/socket.io.min.js"></script>
<script src="../static/js/nearest_neighbors.js"></script>
<!-- Import for loading screen -->
<script src="../static/js/loading.js"></script>

<script type="text/javascript">
    // Container for the loading screen
    var loading = d3.select("#container").append("div")
        .attr("id", "loading");
    // Small list of the first 10000 images in subset folder
    var tmp_ids = {{ tmp_ids |safe }};
    // Display the loading screen
    loading_screen(loading, tmp_ids);

    var svg = d3.select("#container").append("svg")
        .attr("preserveAspectRatio", "none")
        .attr("viewBox", "0 0 " + svgwidth + " " + svgheight)
        .attr("id", "page");

    var removal_transition_speed = 500;
    var appearance_transition_speed = 500;
    var removal_transition_speed_middle_image = 0;
    var time_to_suspend_middle_image_after_click = 0;
    var undo_stack = [];
    var redo_stack = [];
    var old_middle_image = "";
    var selected_locs_dict = {};
    var imgs_path = "static/subset/";
    var defs = svg.append("defs");
    var middle_x = svgwidth * 0.25;
    var middle_y = svgheight * 0.25 - height_navbar / 2 ;
    var middle_width = svgwidth * 0.5;
    var middle_height = svgwidth * 0.25;
    var middle = svg.append("svg")
        .attr("class", "middle")
        .attr("x", middle_x)
        .attr("y", middle_y)
        .attr("width", middle_width)
        .attr("height", middle_height);

    middle.append("rect")
        .attr("class", "middle")
        .attr("width", middle_width)
        .attr("height", middle_height);

    var filter = middle.append("filter")
        .attr("id","blur");

    filter.append("feGaussianBlur")
        .attr("stdDeviation","3.5")
        .attr("result","coloredBlur");

    // middle.append("rect")
	// 	.attr("class", "middle-outline")
	// 	.attr("width", middle_width)
    //     .attr("height", middle_height)
    //     .style("filter", "url(#blur)");

    var center = middle.append("svg");

    // // "Similar images" and "Dissimilar images" labels
    // var font_size_labels = 28;
    // middle.append("text")
    // .attr("x", font_size_labels / 6)
    // .attr("y", middle_height - font_size_labels / 3 - font_size_labels / 12)
    // .text("Similar images")
    // .style("font-size", font_size_labels + "px")
    // .attr("font-family", "Saira");

    // svg.append("text")
    // .attr("x", font_size_labels / 6)
    // .attr("y", height_navbar)
    // .text("Dissimilar images")
    // .style("font-size", font_size_labels + "px")
    // .attr("font-family", "Saira");

    // tooltip
    var tooltip = d3.select("#container")
        .append("div")
        .attr("id", "tooltip")
        .style("position", "absolute")
        .style("z-index", "10")
        .style('color', 'black')
        .style("visibility", "hidden")

    // tooltip buttons
    var tooltip_buttons = d3.select("#container")
        .append("div")
        .attr("id", "tooltip_buttons")
        .style("position", "absolute")
        .style("z-index", "10")
        .style('color', 'black')
        .style("visibility", "hidden")

    // buttons
    var button_svg = svg.append('svg')
        .attr('width', svgwidth / 4)
        .attr('height', 50)
        .attr("x", 0)
        .attr("y", 00)

    var button_size = 40;

    var menubutton = button_svg.append("g")
        .datum({position: [0, 0], height: 35, width: 55})
        .attr("transform", d => "translate(" + d.position + ")");

    var menubutton_circle;
    menubutton.append("circle")
        .attr("class", "button")
        .attr("cx", button_size / 2)
        .attr("cy", button_size / 2)
        .attr("r", button_size / 2)
        .style('opacity', 0)
            .on("mouseover", function(){
                menubutton_circle = this;
                d3.select(this).style('opacity', 0.3)
                timer_tooltip = setTimeout(function () {
                    tooltip_buttons.html("Open menu")
                    return tooltip_buttons.style("visibility", "visible");
                }, time_till_tooltip_appearance);
            })
            .on("mousemove", function(){
            return tooltip_buttons.style("top", (event.pageY+10)+"px").style("left",(event.pageX+20)+"px");})
            .on("mouseout", function(){
                d3.select(this).style('opacity', 0)
                clearTimeout(timer_tooltip);
                return tooltip_buttons.style("visibility", "hidden");
            });;

    menubutton.append("image")
		.attr("href", "static/icons/" + 'menu.png')
        .attr("class", "button")
		.attr("height", button_size / 2)
        .attr("width", button_size / 2)
        .attr("x", button_size / 4)
        .attr("y", button_size / 4)
		.attr("clip-path", "url(#clip)")
        .style('opacity', 1)
        .on("mouseover", function(){
            d3.select(menubutton_circle).style('opacity', 0.3)
            timer_tooltip = setTimeout(function () {
                    tooltip_buttons.html("Open menu")
                    return tooltip_buttons.style("visibility", "visible");
                }, time_till_tooltip_appearance);
        })
        .on("mousemove", function(){
            return tooltip_buttons.style("top", (event.pageY+10)+"px").style("left",(event.pageX+20)+"px");})
        .on("mouseout", function(){
            d3.select(menubutton_circle).style('opacity', 0)
            clearTimeout(timer_tooltip);
            return tooltip_buttons.style("visibility", "hidden");
        });;
        // .attr('fill', 'white');

    menubutton.on('click', function() {
        // randomize all outside images
        openNav()
    });

    var randomizebutton = button_svg.append("g")
        .datum({position: [0, 0], height: 35, width: 55})
        .attr("transform", d => "translate(" + d.position + ")");

    var randomizebutton_circle;
    randomizebutton.append("circle")
        .attr("class", "button")
        .attr("cx", button_size / 2 + button_size / 1.2)
        .attr("cy", button_size / 2)
        .attr("r", button_size / 2)
        .style('opacity', 0)
            .on("mouseover", function(){
                randomizebutton_circle = this;
                d3.select(this).style('opacity', 0.3)
                timer_tooltip = setTimeout(function () {
                    tooltip_buttons.html("Randomize exploration area")
                    return tooltip_buttons.style("visibility", "visible");
                }, time_till_tooltip_appearance);
            })
            .on("mousemove", function(){
                return tooltip_buttons.style("top", (event.pageY+10)+"px").style("left",(event.pageX+20)+"px");})
            .on("mouseout", function(){
                d3.select(this).style('opacity', 0)
                clearTimeout(timer_tooltip);
                return tooltip_buttons.style("visibility", "hidden");
            });;

    randomizebutton.append("image")
        .attr("class", "button")
		.attr("href", "static/icons/" + 'shuffle.png')
		.attr("height", button_size / 2.3)
        .attr("width", button_size / 2.3)
        .attr("x", button_size / 3.4 + button_size / 1.2)
        .attr("y", button_size / 3.4)
		.attr("clip-path", "url(#clip)")
        .style('opacity', 1)
        .on("mouseover", function(){
            d3.select(randomizebutton_circle).style('opacity', 0.3)
            timer_tooltip = setTimeout(function () {
            tooltip_buttons.html("Randomize exploration area")
            return tooltip_buttons.style("visibility", "visible");
            }, time_till_tooltip_appearance);
        })
        .on("mousemove", function(){
            return tooltip_buttons.style("top", (event.pageY+10)+"px").style("left",(event.pageX+20)+"px");})
        .on("mouseout", function(){
            d3.select(randomizebutton_circle).style('opacity', 0)
            clearTimeout(timer_tooltip);
            return tooltip_buttons.style("visibility", "hidden");
        });;
        // .attr('fill', 'white');

    randomizebutton.on('click', function() {
        // randomize all outside images
        change_dissimilar_images()
    });

    var undo_button_circle;
    var undo_button = button_svg.append("g");
    undo_button.append("circle")
        .attr("class", "button")
        .attr("cx", button_size / 2 + button_size / 1.2 + button_size / 1.2)
        .attr("cy", button_size / 2)
        .attr("r", button_size / 2)
        .style('opacity', 0)
        .on("mouseover", function(){
            undo_button_circle = this;
            d3.select(this).style('opacity', 0.3)
            timer_tooltip = setTimeout(function () {
                tooltip_buttons.html("Undo similarity area")
                return tooltip_buttons.style("visibility", "visible");
            }, time_till_tooltip_appearance);
        })
        .on("mousemove", function(){
            return tooltip_buttons.style("top", (event.pageY+10)+"px").style("left",(event.pageX+10)+"px");})
        .on("mouseout", function(){
            d3.select(this).style('opacity', 0)
            clearTimeout(timer_tooltip);
            return tooltip_buttons.style("visibility", "hidden");
        });

    undo_button.append("image")
        .attr("class", "button")
		.attr("href", "static/icons/" + 'undo.png')
		.attr("height", button_size / 2.3)
        .attr("width", button_size / 2.3)
        .attr("x", button_size / 3.4 + button_size / 1.2 + button_size / 1.2)
        .attr("y", button_size / 3.4)
		.attr("clip-path", "url(#clip)")
        .style('opacity', 1)
        .on("mouseover", function(){
            d3.select(undo_button_circle).style('opacity', 0.3)
            timer_tooltip = setTimeout(function () {
                tooltip_buttons.html("Undo similarity area")
                return tooltip_buttons.style("visibility", "visible");
            }, time_till_tooltip_appearance);
        })
        .on("mousemove", function(){
            return tooltip_buttons.style("top", (event.pageY+10)+"px").style("left",(event.pageX+10)+"px");})
        .on("mouseout", function(){
            d3.select(undo_button_circle).style('opacity', 0)
            clearTimeout(timer_tooltip);
            return tooltip_buttons.style("visibility", "hidden");
        });
        // .attr('fill', 'white');

    var redo_button_circle;
    var redo_button = button_svg.append("g");
    redo_button.append("circle")
        .attr("class", "button")
        .attr("cx", button_size / 1.2 + button_size / 2 + button_size / 1.2 + button_size / 1.2)
        .attr('cy', button_size / 2)
        .attr("r", button_size / 2)
        .style('opacity', 0)
        .on("mouseover", function(d){
            redo_button_circle = this;
            d3.select(this).style('opacity', 0.3)
            timer_tooltip = setTimeout(function () {
                tooltip_buttons.html("Redo similarity area")
                return tooltip_buttons.style("visibility", "visible");
            }, time_till_tooltip_appearance);
        })
        .on("mousemove", function(){
            return tooltip_buttons.style("top", (event.pageY+10)+"px").style("left",(event.pageX+10)+"px");})
        .on("mouseout", function(d){
            d3.select(this).style('opacity', 0)
            clearTimeout(timer_tooltip);
            return tooltip_buttons.style("visibility", "hidden");
        });

    redo_button.append("image")
        .attr("class", "button")
		.attr("href", "static/icons/" + 'redo.png')
		.attr("height", button_size / 2.3)
        .attr("width", button_size / 2.3)
        .attr("x", button_size / 1.2 + button_size / 3.4 + button_size / 1.2 + button_size / 1.2)
        .attr('y', button_size / 3.4)
		.attr("clip-path", "url(#clip)")
        .style('opacity', 1)
        .on("mouseover", function(){
            d3.select(redo_button_circle).style('opacity', 0.3)
            timer_tooltip = setTimeout(function () {
                tooltip_buttons.html("Redo similarity area")
                return tooltip_buttons.style("visibility", "visible");
            }, time_till_tooltip_appearance);
        })
        .on("mousemove", function(){
            return tooltip_buttons.style("top", (event.pageY+10)+"px").style("left",(event.pageX+10)+"px");})
        .on("mouseout", function(){
            d3.select(redo_button_circle).style('opacity', 0)
            clearTimeout(timer_tooltip);
            return tooltip_buttons.style("visibility", "hidden");
        });
        // .attr('fill', 'white');

    undo_button.on('click', function() {
        console.log('go back to previous image');
        undo();
    });
    redo_button.on('click', function() {
        console.log('redo images');
        redo()
    });
    // Listener for if the json has been created
    socket.on('json_loaded', function () {
        console.log("JSON CREATED");
        get_meta();
    })

    // // Position "Similar" and "Dissimilar" text label on screen
    // document.getElementById("similar_label").style.left = middle_x + 'px';
    // document.getElementById("similar_label").style.bottom  = svgheight - middle_y + 'px';
    // document.getElementById("dissimilar_label").style.left = randomizebutton_size + 'px';
    // document.getElementById("dissimilar_label").style.top  = height_navbar + 'px';

    // This can be used to execute code once a flag become true
    function TrueListener(callback, init_val=false) {
        this.value = init_val;
        this.onTrue = callback;
        // Check if starting with true
        if (init_val == true) {
            this.onTrue();
        }
        // value getter
        this.get = function() {
            return this.value;
        }
        // value setter
        this.set = function(v) {
            if (v == true) {
                this.value = true;
                this.onTrue();
            }
        }
    }

    var nr_similar_images = 80;
    var nr_dissimilar_images = 30;
    var outside_images = [];
    var outside_subset = [];
    var dissimilar_locs = [];
    var similar_locs = [];
    var temp_similar_locs = [];

    const sleep = (milliseconds) => {
        return new Promise(resolve => setTimeout(resolve, milliseconds));
    }

    function get_meta(listener) {
        fetch("static/subset_meta.json").then(response => {
            if (response.ok) {
                console.log("Loading json from disk");
                return response.json();
            } else {
                console.log("JSON file missing");
                console.log("Sending request to create json");
                socket.emit('create_meta_json');
            }
        })
        .then(json => {
            if (json) {
                data = json;
                available_ids = Object.keys(data);
                console.log("Data loaded");
                artnames_to_ids = {};
                artists_to_ids = {};
                for(const key in data){
                    let art_name = data[key]['artwork_name'].toLowerCase();
                    let artist_name = data[key]['artist_full_name'].toLowerCase();
                    artnames_to_ids[art_name] = key;
                    artists_to_ids[artist_name] = key;
                }
                listener.set(true);
            }
        });
    }

    // create grid for possible locations of images
    var i;
    var j;
    var grid_similar = [];
    var grid_dissimilar = [];

    for (i = 0; i < svgwidth - dissimilar_image_size; i += dissimilar_image_size) {
        for (j = 0; j < svgheight - dissimilar_image_size; j += dissimilar_image_size) {

            // skip middle section and randomize button
            if ((i + dissimilar_image_size > middle_x && i < (middle_x + middle_width)) &&
                    (j + dissimilar_image_size > middle_y && j < (middle_y + middle_height)) ||
                    (i < button_size * 4 + 0.5 && j < button_size * 4 + 0.5))

                continue;

            grid_dissimilar.push([i, j]);
        }
    }

    for (i = middle_x + 4; i < middle_x + middle_width - similar_image_size - 4; i += similar_image_size) {
        for (j = middle_y + 4 ; j < middle_y + middle_height - similar_image_size - 4; j += similar_image_size) {

            // skip action buttons and center image
            if ((i + similar_image_size > middle_x + center_image_x &&
                     i < middle_x + center_image_x + center_image_size &&
                     j + similar_image_size > middle_y + center_image_y &&
                     j < middle_y + center_image_y + center_image_size))

                continue;

            grid_similar.push([i, j]);
        }
    }

    // global vars for nearest and explore images ids
    var images_ids_subset
    var nearest_ids

    // ---------------- Helper Functions ------------------
    function change_dissimilar_images(start_time=-2500, end_time = 2017) {
        console.log("3--start and end year for Filtering:",start_time, end_time);
        var temp_time;
        if(start_time > end_time){
            alert("[Filtering Warning]: There the end year should be later or equal to start year");
            [start_time, end_time] = [end_time, start_time]
            console.log("6666--start and end year for Filtering:",start_time, end_time);
        };
        if(end_time > 2017){
            end_time = 2017;
        };
        if(start_time < -2500){
            start_time < -2500;
        };

        images_ids = available_ids.filter(n => !nearest_ids.includes(n));
        filtered_ids = images_ids.filter(filter_fun);
        function filter_fun(my_id){
            return data[my_id]["creation_year"] >= start_time && data[my_id]["creation_year"] <= end_time;
        }

        console.log("#########################",images_ids, data['1000']);
        sorted_images_ids = filtered_ids.sort(() => Math.random() - 0.5);
        images_ids_subset = sorted_images_ids.slice(0, nr_dissimilar_images);
        grid_dissimilar = grid_dissimilar.sort(() => Math.random() - 0.5);
        dissimilar_locs = grid_dissimilar.slice(0, nr_dissimilar_images);

        plot_dissimilar_images(images_ids_subset);
    }

    function plot_dissimilar_images(images_ids_subset, transition=true) {

        images_ids_subset_int = images_ids_subset.map(Number)
        get_cosine_sim(middle_image, images_ids_subset_int);

        // Remove all current images
        d3.selectAll("g#outside_image")
            .transition()
            .duration(removal_transition_speed)
            .style("opacity", 0)
            .remove();

        // Sleep for 100 ms until similarity found
        sleep(100).then(() => {
            // --- selecting location of dis-similar layer and plotting those images:
            var i;
            for (i = 0; i < images_ids_subset.length; i++) {
                meta_data_painting = data[images_ids_subset[i]]
                artwork_name = meta_data_painting['artwork_name']
                artist_full_name = meta_data_painting['artist_full_name']
                creation_year = meta_data_painting["creation_year"]
                cosine_sim = (Math.round(cos_sims_explore[i] * 100) / 100).toFixed(2);
                sim_score = Math.round(cosine_sim * 100)
                appendDraggableImage(imgs_path + images_ids_subset[i].toString() + ".jpg", dissimilar_locs[i], artwork_name, artist_full_name, sim_score,
                    creation_year, transition)
            };

            console.log("change dissimilar");

        });

    }

    function my_set_center(){
        search_cat = document.getElementById("search_cat").value.toLowerCase();
        if(search_cat === "art name")
        {
            dictionary = artnames_to_ids;
        }
        else
        {
            dictionary = artists_to_ids;
        }
        let dict_search_key = document.getElementById("search_key").value.toLowerCase();
        image_to_be_set = dictionary[dict_search_key];
        if (image_to_be_set !== undefined && dict_search_key != ""){
            handle_stacks();
            middle_image = image_to_be_set;
            d3.select('image#center').remove();
            set_center(center, image_to_be_set);
            change_similar_images();
        }
        else{
            alert("Searched image not found...");
        }
        closeNav();
    }

    function filter_dissimilar(){

        // start_year = parseInt(document.getElementById("start_year").value);
        // end_year = parseInt(document.getElementById("end_year").value);

        let start_point = document.getElementById("start_year").value;
        let end_point = document.getElementById("end_year").value;

        if(start_point == ""){
            start_point = "-2500";
        };

        if(end_point == ""){
            end_point = "2017";
        }

        start_year = parseInt(start_point);
        end_year = parseInt(end_point);

        change_dissimilar_images(start_year, end_year);
        closeNav()
    }



    function handle_stacks(){
        /*
        After clicking on a image central image changes. Here we add the current image before updating the central image.
        So we will be able to retrieve this state after pushing the update button.
         */
        undo_stack.push(middle_image);
    }


    function change_similar_images() {
        /*
        Here we find the "n" similar images to the central image, using KNN method.
        We also define the coordinates for each of those similar images.
        */
        nearest_neighbors(middle_image, nr_similar_images);

        // if central image has been seen before use the precomputed locations for similar images otherwise calculate their positions:
        if (selected_locs_dict[middle_image.toString()] == undefined){
            grid_similar = grid_similar.sort(() => Math.random() - 0.5);
            temp_similar_locs = grid_similar.slice(0, nr_similar_images);
            selected_locs_dict[middle_image.toString()] = temp_similar_locs;
        }
        else {
            temp_similar_locs = selected_locs_dict[middle_image.toString()];
        }
        similar_locs = temp_similar_locs;

        // Remove all current images
        d3.selectAll("g#middle_image")
            .transition()
            .duration(removal_transition_speed)
            .style("opacity", 0)
            .remove()

        // Sleep for 500 ms until neighbouring images is found
        sleep(500).then(() => {
            // --- selecting location of similar layer and plotting those images:
            // Start i from 1 to filter-out central image:
            var i;
            console.log("nearest ids:", nearest_ids)
            const center_x = parseFloat(d3.select("image#center").attr("x"));
            const center_y = parseFloat(d3.select("image#center").attr("y"));
            const center_width = parseFloat(d3.select("image#center").attr("width"));
            const center_height = parseFloat(d3.select("image#center").attr("height"));
            const center_info = {"x": center_x, "y": center_y, "width": center_width, "height": center_height};
            const outer = {"x": 0, "y": 0, "width": middle_width, "height": middle_height};
            similar_layout(middle, nearest_ids, center_info, outer, data);
            // for (i = 1; i < nearest_ids.length; i++) {
            //     meta_data_painting = data[nearest_ids[i]]
            //     artwork_name = meta_data_painting['artwork_name']
            //     artist_full_name = meta_data_painting['artist_full_name']
            //     creation_year = meta_data_painting['creation_year']
            //     cosine_sim = (Math.round(cos_sims_nearest[i] * 100) / 100).toFixed(2);
            //     sim_score = Math.round(cosine_sim * 100)
            //     appendImage(imgs_path + nearest_ids[i].toString() + ".jpg",
            //         similar_locs[i-1], artwork_name, artist_full_name,
            //         sim_score, creation_year);
            // };

            // Update outside images for similarity score
            plot_dissimilar_images(images_ids_subset, transition=false)
            console.log("change similar");

        });

    }

    function redo() {
        if (redo_stack.length === 0)
            return;
        undo_stack.push(middle_image);

        // remove current image from undo stack:
        middle_image = redo_stack.pop();
        d3.select('image#center').remove();
        set_center(center, middle_image);
        change_similar_images();
    }

    function undo() {
        if (undo_stack.length === 0)
            return;
        redo_stack.push(middle_image);

        // remove current image from undo stack:
        middle_image = undo_stack.pop();
        d3.select('image#center').remove()
        set_center(center, middle_image);
        change_similar_images();

    }
    // ----------------------------------------------------------------------------


    // Data loading from json
    var data;
    var available_ids;
    var middle_image;
    var artnames_to_ids;
    var artists_to_ids;

    // Once DATA_LOADED is set to true in get_meta(), setup the page
    DATA_LOADED = new TrueListener(function() {
        middle_image = available_ids[Math.floor(Math.random() * available_ids.length)];
        set_center(center, middle_image);
        change_similar_images();
        change_dissimilar_images();
        handle_stacks();
        console.log("Page ready");
        imageLoader.terminate(); // Terminate the image loader worker
        showPage();
        setTimeout(clearIntervals(), 500);

    })

    // Call get_meta to load the metadata
    get_meta(DATA_LOADED);

    // This function fades out the loading page and then fades in the actual page
    function showPage() {
        time = 1000;
        d3.select("#loading")
            .transition()
            .duration(time)
            .style("opacity", 0)
            // Once the loading page has faded out, remove it and fade normal page in
            .on("end", function () {
                d3.select(this).remove();
                d3.select("#page")
                .style("display", "block")
                .transition()
                .duration(time)
                .style("opacity", 1);
                d3.select(".header")
                .style('opacity', 1);
            });
    }

</script>
</html>
